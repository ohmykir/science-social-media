<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${userProfile.user.firstName + ' ' + userProfile.user.lastName + ' - MindLink'}">Профиль пользователя</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/styles/user-profile.css}">
    <link rel="stylesheet" th:href="@{/styles/common.css}">
</head>
<body>

<nav class="navbar">
    <div class="nav-container">
        <a th:href="@{/}" class="logo">
            <i class="fas fa-flask-vial"></i>
            MindLink
        </a>
        <div class="nav-links">
            <a th:href="@{/}" class="nav-link">Главная</a>
            <div sec:authorize="isAuthenticated()">
                <a th:href="@{/user(id=${currentUserId})}" class="nav-link">Мой профиль</a>
                <a th:href="@{/logout}" class="nav-link btn-logout">Выйти</a>
            </div>
            <div sec:authorize="!isAuthenticated()">
                <a th:href="@{/login}" class="nav-link btn-login">Войти</a>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    <div class="user-profile">
        <div class="user-avatar">
            <img th:if="${userProfile.user.profilePhotoPath}"
                 th:src="@{${userProfile.user.profilePhotoPath}}"
                 alt="Аватар пользователя">
            <img th:unless="${userProfile.user.profilePhotoPath}"
                 th:src="@{/images/default-avatar.png}"
                 alt="Аватар по умолчанию">
        </div>
        <div class="user-info">
            <h1 class="username" th:text="${userProfile.user.username}">username</h1>
            <h2 class="full-name" th:text="${userProfile.user.firstName + ' ' + userProfile.user.lastName}">Имя Фамилия</h2>
            <p class="bio" th:text="${userProfile.user.bio}">Биография пользователя</p>

            <div class="profile-actions">
                <button th:if="${isOwner}" id="show-upload-form" class="btn-primary">
                    <i class="fas fa-plus"></i>
                    Добавить статью
                </button>
                <a th:if="${isOwner}" th:href="@{/user/edit}" class="btn-secondary">
                    <i class="fas fa-edit"></i>
                    Редактировать профиль
                </a>
                <button th:unless="${isOwner}" class="subscribe-btn"
                        th:attr="data-user-id=${userProfile.user.id}"
                        th:text="${userProfile.isSubscribed()} ? 'Отписаться' : 'Подписаться'">
                </button>
            </div>
        </div>
    </div>

    <div th:if="${isOwner}" id="upload-form-container" class="modal">
        <div class="modal-content">
            <button class="close">&times;</button>
            <h3>
                <i class="fas fa-file-import"></i>
                Загрузка статей из BibTeX
            </h3>

            <div class="import-tabs">
                <button class="import-tab-btn active" onclick="switchImportTab('file-tab')">
                    <i class="fas fa-file-upload"></i>
                    Загрузить файл
                </button>
                <button class="import-tab-btn" onclick="switchImportTab('text-tab')">
                    <i class="fas fa-keyboard"></i>
                    Вставить текст
                </button>
            </div>

            <div id="file-tab" class="import-tab-content active">
                <form th:action="@{/import/bibtex}" method="post" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="file">Выберите файл (.txt, .bib, .bibtex):</label>
                        <input type="file" id="file" name="file" accept=".txt,.bib,.bibtex" required>
                        <small>Поддерживаются файлы с BibTeX структурой</small>
                    </div>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-upload"></i>
                        Загрузить файл
                    </button>
                </form>
            </div>

            <div id="text-tab" class="import-tab-content">
                <form th:action="@{/import/bibtex-text}" method="post">
                    <div class="form-group">
                        <label for="bibtex-text">Вставьте BibTeX текст:</label>
                        <textarea id="bibtex-text" name="bibtexContent"
                                  placeholder="@article{key2023,&#10;  title={Название},&#10;  author={Автор},&#10;  journal={Журнал},&#10;  year={2023}&#10;}"
                                  rows="8" required></textarea>
                        <small>Вставьте один или несколько BibTeX записей</small>
                    </div>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-check"></i>
                        Импортировать текст
                    </button>
                </form>
            </div>
        </div>
    </div>



    <div th:if="${success}" class="alert alert-success">
        <i class="fas fa-check-circle"></i>
        <span th:text="${success}"></span>
    </div>
    <div th:if="${warnings}" class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i>
        <div th:each="warning : ${warnings}" th:text="${warning}"></div>
    </div>
    <div th:if="${error}" class="alert alert-error">
        <i class="fas fa-times-circle"></i>
        <span th:text="${error}"></span>
    </div>

    <div class="content-wrapper">
        <div class="articles-section">
            <div class="articles-header">
                <h3>
                    <i class="fas fa-book"></i>
                    Статьи
                    <span class="articles-count" th:text="'(' + ${userProfile.articles.size()} + ')'">0</span>
                </h3>
                <select id="sort-selector" class="sort-select">
                    <option value="date" th:selected="${currentSort == 'date'}">По дате</option>
                    <option value="title" th:selected="${currentSort == 'title'}">По названию</option>
                    <option value="likes" th:selected="${currentSort == 'likes'}">По лайкам</option>
                    <option value="comments" th:selected="${currentSort == 'comments'}">По комментариям</option>
                    <option value="year" th:selected="${currentSort == 'year'}">По году</option>
                </select>
            </div>

            <div class="articles-list" id="articles-container">
                <div class="article-item" th:each="article : ${userProfile.articles}">
                    <div class="article-content">
                        <h4 class="article-title">
                            <a th:href="@{/article(id=${article.article.id})}" th:text="${article.article.title}">Название статьи</a>
                        </h4>
                        <div class="article-meta">
                            <span class="article-journal" th:text="${article.article.journal}">Журнал</span>
                            <span class="article-year" th:text="${article.article.year}">2023</span>
                        </div>
                        <div class="article-authors" th:text="${article.article.author}">Авторы</div>
                    </div>
                    <div class="article-actions">
                        <div class="action-item">
                            <i class="fas fa-heart like-icon"></i>
                            <span class="count" th:text="${article.likeCount}">0</span>
                        </div>
                        <div class="action-item">
                            <i class="fas fa-comments comment-icon"></i>
                            <span class="count" th:text="${article.commentCount}">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="view-toggle">
                <button id="list-view" class="view-btn active">
                    <i class="fas fa-list"></i>
                    Список
                </button>
                <button id="grid-view" class="view-btn">
                    <i class="fas fa-th"></i>
                    Плитки
                </button>
            </div>
        </div>

        <div class="sidebar">
            <div class="stats-card">
                <h4><i class="fas fa-chart-bar"></i> Статистика</h4>
                <div class="stat-item clickable" id="show-subscribers">
                    <span class="stat-label">Подписчиков:</span>
                    <span class="stat-value" th:text="${userProfile.subscriberCount}">0</span>
                </div>
                <div class="stat-item clickable" id="show-subscriptions">
                    <span class="stat-label">Подписок:</span>
                    <span class="stat-value" th:text="${userProfile.subscriptionCount}">0</span>
                </div>
            </div>

            <div id="users-modal" class="modal">
                <div class="modal-content">
                    <button class="close">&times;</button>
                    <h3 id="modal-title"></h3>
                    <div id="users-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/js/user-profile.js}"></script>
</body>
</html>